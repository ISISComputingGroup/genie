"""
Genie Advance module:

This module is used for advanced commands that are for expert users.
"""

import sys
from datetime import datetime, timedelta

from time import sleep

from genie_python.genie_api_setup import __api, helparglist, usercommand, _handle_exception
from genie_python.utilities import check_break
from genie_python.genie_waitfor import DELAY_IN_WAIT_FOR_SLEEP_LOOP


@usercommand
@helparglist('block str')
def get_pv_from_block(block):
    """
    Get the full PV name for a given block.
    This is an advanced function because of the need to use the pv name correctly.

    Args:
        block (str): A block object

    Returns:
        pv_name (Str): The pv name as a string

    """
    __api.log_command(sys._getframe().f_code.co_name, locals())
    try:
        return __api.get_pv_from_block(block)
    except Exception as e:
        _handle_exception(e)


@usercommand
@helparglist('pv str, value[, maxwait]')
def wait_for_pv(pv, value, maxwait=None):
    """
    Wait until a PV has reached a given value.

    Params:
        pv (str): The address of the PV
        value: The value to wait for
        maxwait (int, optional): The maximum time to wait for in seconds
    """
    start_time = datetime.utcnow()
    while True:
        curr_value = __api.get_pv_value(pv)
        if curr_value == value:
            break
        if maxwait is not None:
            if timedelta(seconds=maxwait) < datetime.utcnow() - start_time:
                break
        sleep(DELAY_IN_WAIT_FOR_SLEEP_LOOP)
        check_break(2)


@usercommand
@helparglist('')
def set_begin_precmd(begin_precmd):
    """
    Set the function to call before the begin command.

    Args:
        begin_precmd (function): The function to call (which should return None if it wants the run to start,
          or a string with the reason why not to start run).
    """
    __api.pre_post_cmd_manager.begin_precmd = begin_precmd


@usercommand
@helparglist('')
def set_begin_postcmd(begin_postcmd):
    """
    Set the function to call after the begin command.

    Args:
        begin_postcmd (function): The function to call.
    """
    __api.pre_post_cmd_manager.begin_postcmd = begin_postcmd


@usercommand
@helparglist('')
def set_abort_precmd(abort_precmd):
    """
    Set the function to call before the abort command.

    Args:
        abort_precmd (function): The function to call.
    """
    __api.pre_post_cmd_manager.abort_precmd = abort_precmd


@usercommand
@helparglist('')
def set_abort_postcmd(abort_postcmd):
    """
    Set the function to call after the abort command.

    Args:
        abort_postcmd (function): The function to call.
    """
    __api.pre_post_cmd_manager.abort_postcmd = abort_postcmd


@usercommand
@helparglist('')
def set_end_precmd(end_precmd):
    """
    Set the function to call before the end command.

    Args:
        end_precmd (function): The function to call.
    """
    __api.pre_post_cmd_manager.end_precmd = end_precmd


@usercommand
@helparglist('')
def set_end_postcmd(end_postcmd):
    """
    Set the function to call after the end command.

    Args:
        end_postcmd (function): The function to call.
    """
    __api.pre_post_cmd_manager.end_postcmd = end_postcmd


@usercommand
@helparglist('')
def set_pause_precmd(pause_precmd):
    """
    Set the function to call before the pause command.

    Args:
        end_precmd (function): The function to call.
    """
    __api.pre_post_cmd_manager.pause_precmd = pause_precmd


@usercommand
@helparglist('')
def set_pause_postcmd(pause_postcmd):
    """
    Set the function to call after the pause command.

    Args:
        pause_postcmd (function): The function to call.
    """
    __api.pre_post_cmd_manager.pause_postcmd = pause_postcmd


@usercommand
@helparglist('')
def set_resume_precmd(resume_precmd):
    """
    Set the function to call before the resume command.

    Args:
        resume_precmd (function): The function to call.
    """
    __api.pre_post_cmd_manager.resume_precmd = resume_precmd


@usercommand
@helparglist('')
def set_resume_postcmd(resume_postcmd):
    """
    Set the function to call after the resume command.

    Args:
        resume_postcmd (function): The function to call.
    """
    __api.pre_post_cmd_manager.resume_postcmd = resume_postcmd
