"""
Genie Advance module:

This module is used for advanced commands that are for expert users.
"""

import sys
from datetime import datetime, timedelta

from time import sleep

from genie_python.genie_api_setup import __api, helparglist, usercommand, _handle_exception
from genie_python.utilities import check_break
from genie_waitfor import DELAY_IN_WAIT_FOR_SLEEP_LOOP


@usercommand
@helparglist('block str')
def get_pv_from_block(block):
    """
    Get the full PV name for a given block.
    This is an advanced function because of the need to use the pv name correctly.

    Args:
        block (str): A block object

    Returns:
        pv_name (Str): The pv name as a string

    """
    __api.log_command(sys._getframe().f_code.co_name, locals())
    try:
        return __api.get_pv_from_block(block)
    except Exception as e:
        _handle_exception(e)


@usercommand
@helparglist('pv str, value[, maxwait]')
def wait_for_pv(pv, value, maxwait=None):
    """
    Wait until a PV has reached a given value.

    Params:
        pv (str): The address of the PV
        value: The value to wait for
        maxwait (int, optional): The maximum time to wait for in seconds
    """
    start_time = datetime.utcnow()
    while True:
        curr_value = __api.get_pv_value(pv)
        if curr_value == value:
            break
        if maxwait is not None:
            if timedelta(seconds=maxwait) < datetime.utcnow() - start_time:
                break
        sleep(DELAY_IN_WAIT_FOR_SLEEP_LOOP)
        check_break(2)
