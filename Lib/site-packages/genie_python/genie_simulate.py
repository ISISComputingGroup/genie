from __future__ import absolute_import
from __future__ import print_function
from builtins import object
import genie_python.genie_simulate_impl as genie_sim
import genie_python.genie_api_setup


def in_sim_mode():
    """
    Get whether genie_python is in simulation mode.

    Returns (bool): True if in simulation mode, False otherwise
    """
    from genie_python.genie import _genie_api
    return isinstance(_genie_api, genie_sim.API)


class Simulate(object):
    """A context manager that will put genie_python into simulation mode and out again.
    For example:
    >>> with g.sim.Simulate():
    >>>     g.begin()
    >>>     g.cset("my_block", 10)
    >>>     g.end()
    Will run only print the results of the g. commands and not change the current experiment.
    """
    def __init__(self, populate_with_current_blocks=True):
        """
        Create the context manager.

        Args:
            populate_with_current_blocks(bool): if True the simulated environment will be populated with the current blocks
        """
        from genie_python import genie
        from genie_python.genie import _genie_api
        self.genie = genie
        self.previous_api = _genie_api
        self.new_api = genie_sim.API(None, None, populate_with_current_blocks)
        if populate_with_current_blocks:
            dummy_values = ["INITIAL_VALUE"] * len(self.previous_api.get_block_names())
            self.new_api.set_multiple_blocks(self.previous_api.get_block_names(), dummy_values)

    def __enter__(self):
        genie_python.genie_api_setup._exceptions_raised = True
        self.genie._genie_api = self.new_api

    def __exit__(self, *args):
        genie_python.genie_api_setup._exceptions_raised = False
        self.genie._genie_api = self.previous_api
