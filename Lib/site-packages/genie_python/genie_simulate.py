from __future__ import absolute_import
from __future__ import print_function
from builtins import object
from genie import _get_correct_globals
import genie_python.genie_simulate_impl as genie_sim
import genie_python.genie_api_setup


def in_sim_mode():
    from genie_python.genie import _genie_api
    return isinstance(_genie_api, genie_sim.API)


class Simulate(object):
    def __init__(self, populate_with_current_blocks=True):
        from genie_python import genie
        from genie_python.genie import _genie_api
        self.genie = genie
        self.previous_api = _genie_api
        self.new_api = genie_sim.API(None, _get_correct_globals())
        if populate_with_current_blocks:
            dummy_values = ["INITIAL_VALUE"] * len(self.previous_api.get_block_names())
            self.new_api.set_multiple_blocks(self.previous_api.get_block_names(), dummy_values)

    def __enter__(self):
        genie_python.genie_api_setup._exceptions_raised = True
        self.genie._genie_api = self.new_api

    def __exit__(self, *args):
        genie_python.genie_api_setup._exceptions_raised = False
        self.genie._genie_api = self.previous_api
