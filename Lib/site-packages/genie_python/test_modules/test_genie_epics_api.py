# This file is part of the ISIS IBEX application.
# Copyright (C) 2012-2016 Science & Technology Facilities Council.
# All rights reserved.
#
# This program is distributed in the hope that it will be useful.
# This program and the accompanying materials are made available under the
# terms of the Eclipse Public License v1.0 which accompanies this distribution.
# EXCEPT AS EXPRESSLY SET FORTH IN THE ECLIPSE PUBLIC LICENSE V1.0, THE PROGRAM
# AND ACCOMPANYING MATERIALS ARE PROVIDED ON AN "AS IS" BASIS, WITHOUT WARRANTIES
# OR CONDITIONS OF ANY KIND.  See the Eclipse Public License v1.0 for more details.
#
# You should have received a copy of the Eclipse Public License v1.0
# along with this program; if not, you can obtain a copy from
# https://www.eclipse.org/org/documents/epl-v10.php or
# http://opensource.org/licenses/eclipse-1.0.php

from __future__ import absolute_import
import unittest
from mock import MagicMock, patch
from genie_python.genie_epics_api import API


class TestEpicsApiSequence(unittest.TestCase):
    def setUp(self):
        # Patch the Wrapper used by the api
        wrapper_patch = patch("genie_python.genie_epics_api.Wrapper")
        # Make sure the patch is destroyed on teardown
        self.addCleanup(wrapper_patch.stop)
        # Create a mock from the patch
        self.mock_wrapper = wrapper_patch.start()

        self.counter = 0
        self.mock_pv_value = "Mock PV value"
        self.api = API("", None)
        self.mock_wrapper.get_pv_value = MagicMock(return_value=self.mock_pv_value)
        API.blockserver = MagicMock()

    def tearDown(self):
        pass

    def _increase_counter(self):
        self.counter += 1

    def test_WHEN_reloading_current_config_THEN_command_is_delegated_to_blockserver(self):

        # Arrange
        API.blockserver.reload_current_config = MagicMock(side_effect=self._increase_counter)
        # Act
        self.api.reload_current_config()

        # Assert
        self.assertEqual(self.counter, 1)

    def test_GIVEN_list_of_one_element_with_PV_prefix_sample_WHEN_get_sample_pars_is_called_THEN_returns_a_one_element_dictionary_containing_the_PV_suffix_and_mock_value(self):
        # Arrange
        pv_prefix = u'PARS:SAMPLE:'
        pv_suffix = u'AOI'
        pv_name = pv_prefix + pv_suffix
        self.api.blockserver.get_sample_par_names = MagicMock(return_value=[pv_name])

        # Act
        val = self.api.get_sample_pars()

        # Assert
        self.assertEqual(len(val), 1)
        self.assertEqual(list(val.keys())[0], pv_suffix)
        self.assertEqual(val[pv_suffix], self.mock_pv_value)

    def test_GIVEN_list_of_one_element_with_PV_prefix_not_sample_WHEN_get_sample_pars_is_called_THEN_returns_an_empty_dictionary(self):
        # Arrange
        pv_prefix = u'PARS:BL:'
        pv_suffix = u'BEAMSTOP:POS'
        pv_name = pv_prefix + pv_suffix
        self.api.blockserver.get_sample_par_names = MagicMock(return_value=[pv_name])

        # Act
        val = self.api.get_sample_pars()

        # Assert
        self.assertEqual(len(val), 0)

    def test_GIVEN_list_of_one_element_with_PV_prefix_bl_WHEN_get_beamline_pars_is_called_THEN_returns_a_one_element_dictionary_containing_the_PV_suffix_and_mock_value(self):
        # Arrange
        pv_prefix = u'PARS:BL:'
        pv_suffix = u'JOURNAL:BLOCKS'
        pv_name = pv_prefix + pv_suffix
        self.api.blockserver.get_beamline_par_names = MagicMock(return_value=[pv_name])

        # Act
        val = self.api.get_beamline_pars()

        # Assert
        self.assertEqual(len(val), 1)
        self.assertEqual(list(val.keys())[0], pv_suffix)
        self.assertEqual(val[pv_suffix], self.mock_pv_value)

    def test_GIVEN_list_of_one_element_with_PV_prefix_not_bl_WHEN_get_beamline_pars_is_called_THEN_returns_an_empty_dictionary(self):
        # Arrange
        pv_prefix = u'PARS:SAMPLE:'
        pv_suffix = u'HEIGHT'
        pv_name = pv_prefix + pv_suffix
        self.api.blockserver.get_beamline_par_names = MagicMock(return_value=[pv_name])

        # Act
        val = self.api.get_beamline_pars()

        # Assert
        self.assertEqual(len(val), 0)


class TestEpicsApiSetInstrumentName(unittest.TestCase):
    def setUp(self):
        self.api = API("", None)

    def test_WHEN_machine_identifier_begins_ndx_THEN_instrument_is_name_without_ndx(self):
        # Act
        expected = "NAME"
        instrument, machine, pv_prefix = self.api._get_machine_details_from_identifier("NDX" + expected)

        # Assert
        self.assertEqual(expected, instrument)

    def test_WHEN_machine_identifier_begins_ndx_THEN_machine_name_is_machine_identifier(self):
        # Act
        expected = "NDXNAME"
        instrument, machine, pv_prefix = self.api._get_machine_details_from_identifier(expected)

        # Assert
        self.assertEqual(expected, machine)

    def test_WHEN_machine_identifier_begins_ndx_THEN_pv_prefix_begins_with_in_colon(self):
        # Act
        name = "NAME"
        instrument, machine, pv_prefix = self.api._get_machine_details_from_identifier("NDX" + name)
        expected = "IN:" + name + ":"

        # Assert
        self.assertEqual(expected, pv_prefix)

    def test_WHEN_machine_identifier_begins_ndw_THEN_instrument_is_same_as_name(self):
        # Act
        expected = "NDWNAME"
        instrument, machine, pv_prefix = self.api._get_machine_details_from_identifier(expected)

        # Assert
        self.assertEqual(expected, instrument)

    def test_WHEN_machine_identifier_begins_ndw_THEN_machine_name_is_machine_identifier(self):
        # Act
        expected = "NDWNAME"
        instrument, machine, pv_prefix = self.api._get_machine_details_from_identifier(expected)

        # Assert
        self.assertEqual(expected, machine)

    def test_WHEN_machine_identifier_begins_ndw_THEN_pv_prefix_begins_with_the_colon(self):
        # Act
        machine = "NDWname"
        instrument, machine, pv_prefix = self.api._get_machine_details_from_identifier(machine)
        expected = "TE:" + machine + ":"

        # Assert
        self.assertEqual(expected, pv_prefix)

    def test_WHEN_machine_identifier_begins_nde_THEN_instrument_is_name_without_nde(self):
        # Act
        expected = "NAME"
        instrument, machine, pv_prefix = self.api._get_machine_details_from_identifier("NDE"+expected)

        # Assert
        self.assertEqual(expected, instrument)

    def test_WHEN_machine_identifier_begins_nde_THEN_machine_name_is_machine_identifier(self):
        # Act
        expected = "NDENAME"
        instrument, machine, pv_prefix = self.api._get_machine_details_from_identifier(expected)

        # Assert
        self.assertEqual(expected, machine)

    def test_WHEN_machine_identifier_begins_nde_THEN_pv_prefix_begins_with_in_colon(self):
        # Act
        name = "NAME"
        instrument, machine, pv_prefix = self.api._get_machine_details_from_identifier("NDE" + name)
        expected = "IN:" + name + ":"

        # Assert
        self.assertEqual(expected, pv_prefix)

    def test_WHEN_machine_identifier_begins_ndlt_THEN_instrument_is_same_as_machine_name(self):
        # Act
        expected = "NDLTNAME"
        instrument, machine, pv_prefix = self.api._get_machine_details_from_identifier(expected)

        # Assert
        self.assertEqual(expected, instrument)

    def test_WHEN_machine_identifier_begins_ndlt_THEN_machine_name_is_machine_identifier(self):
        # Act
        expected = "NDLTNAME"
        instrument, machine, pv_prefix = self.api._get_machine_details_from_identifier(expected)

        # Assert
        self.assertEqual(expected, machine)

    def test_WHEN_machine_identifier_begins_in_colon_THEN_instrument_is_name_without_prefix(self):
        # Act
        expected = "NAME"
        instrument, machine, pv_prefix = self.api._get_machine_details_from_identifier("IN:" + expected + ":")

        # Assert
        self.assertEqual(expected, instrument)

    def test_WHEN_machine_identifier_begins_in_colon_THEN_machine_name_is_machine_identifier(self):
        # Act
        name = "NAME"
        instrument, machine, pv_prefix = self.api._get_machine_details_from_identifier("IN:" + name + ":")

        # Assert
        self.assertEqual("NDX" + name, machine)

    def test_WHEN_machine_identifier_begins_with_instrument_prefix_THEN_pv_prefix_begins_with_the_colon(self):
        # Act
        expected = "IN:NAME:"
        instrument, machine, pv_prefix = self.api._get_machine_details_from_identifier(expected)

        # Assert
        self.assertEqual(expected, pv_prefix)

    def test_WHEN_machine_identifier_begins_ndlt_THEN_pv_prefix_begins_with_the_colon(self):
        # Act
        machine = "NDLTNAME"
        instrument, machine, pv_prefix = self.api._get_machine_details_from_identifier(machine)
        expected = "TE:" + machine + ":"

        # Assert
        self.assertEqual(expected, pv_prefix)

        
class TestEpicsApiSMS(unittest.TestCase):
    def setUp(self):
        self.api = API("", None)
        API.sms = MagicMock()

    def tearDown(self):
        pass

    def mock_get_pv_value(self, pv_name, to_string):
        self.assertEqual(to_string, True)

        if pv_name == "ALARM_PV.SEVR":
            return "INVALID"
        else:
            raise Exception

    def test_GIVEN_phone_number_WHEN_send_sms_THEN_requests_api_send_sms(self):
        # Arrange
        API.sms.send_sms = MagicMock(return_value="OK")

        # Act
        self.api.send_sms("123", "test")

        # Assert
        API.sms.send_sms.assert_called_once()

    def test_GIVEN_email_address_WHEN_send_email_THEN_requests_api_send_email(self):
        # Arrange
        API.sms.send_email = MagicMock(return_value="OK")

        # Act
        self.api.send_email("a@b", "message")

        # Assert
        API.sms.send_email.assert_called_once()

    def test_GIVEN_message_WHEN_send_alert_THEN_requests_api_send_alert(self):
        # Arrange
        API.sms.send_alert = MagicMock(return_value="OK")

        # Act
        self.api.send_alert("message", "inst")

        # Assert
        API.sms.send_alert.assert_called_once()

    def test_GIVEN_pv_with_field_WHEN_remove_field_called_THEN_field_removed(self):
        self.assertEqual(self.api.remove_field_from_pv("IN:TEST:BLAH.RVAL"), "IN:TEST:BLAH")

    def test_GIVEN_pv_with_no_field_WHEN_remove_field_called_THEN_pv_returned_unchanged(self):
        self.assertEqual(self.api.remove_field_from_pv("IN:TEST:BLAH"), "IN:TEST:BLAH")

    def test_GIVEN_pv_name_WHEN_pv_connected_THEN_get_pv_alarm(self):
        self.api.get_pv_value = self.mock_get_pv_value

        self.assertEqual(self.api.get_alarm_of_pv("ALARM_PV"), "INVALID")

    def test_GIVEN_pv_name_WHEN_pv_not_connected_THEN_get_pv_alarm(self):
        self.api.get_pv_value = self.mock_get_pv_value

        self.assertEqual(self.api.get_alarm_of_pv("DISCONNECTED_PV"), "UNKNOWN")
